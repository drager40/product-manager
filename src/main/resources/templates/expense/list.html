<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHN ê²½ë¹„ ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; }

        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 40px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 16px; font-size: 14px; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        .nav-links { display: flex; gap: 12px; }
        .nav-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 13px; padding: 4px 10px; border-radius: 4px; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.2); }

        .container { max-width: 1200px; margin: 24px auto; padding: 0 20px; }

        .filter-bar { background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 20px; display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; }
        .filter-group label { font-size: 11px; font-weight: 600; color: #666; }
        .filter-group select { padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-width: 110px; height: 34px; }

        .ym-dropdown { position: relative; }
        .ym-dropdown-btn { padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-width: 110px; height: 34px; background: white; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .ym-dropdown-btn::after { content: '\25BC'; font-size: 9px; color: #999; margin-left: 8px; }
        .ym-dropdown-list { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); z-index: 100; min-width: 160px; max-height: 280px; overflow-y: auto; margin-top: 2px; }
        .ym-dropdown-list.open { display: block; }
        .ym-dropdown-list label { display: flex; align-items: center; gap: 8px; padding: 7px 12px; cursor: pointer; font-size: 13px; font-weight: 400; margin: 0; }
        .ym-dropdown-list label:hover { background: #f5f5ff; }
        .ym-dropdown-list label.all-label { border-bottom: 1px solid #eee; font-weight: 600; }
        .ym-dropdown-list input[type="checkbox"] { accent-color: #667eea; }
        .btn-filter { padding: 0 16px; height: 34px; line-height: 34px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: inherit; display: inline-flex; align-items: center; }
        .btn-filter:hover { background: #5a6fd6; }
        .btn-reset { padding: 0 12px; height: 34px; line-height: 34px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; text-decoration: none; display: inline-flex; align-items: center; }
        .btn-group-right { display: flex; gap: 6px; flex-shrink: 0; }
        .btn-add { padding: 7px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; text-decoration: none; white-space: nowrap; }
        .btn-add:hover { background: #43a047; }

        .summary { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-card { background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); flex: 1; min-width: 150px; }
        .summary-card .label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .summary-card .value { font-size: 18px; font-weight: 700; color: #333; }
        .summary-card.budget-total { border-left: 4px solid #667eea; }
        .summary-card.monthly { border-left: 4px solid #42a5f5; }
        .summary-card.prev { border-left: 4px solid #66bb6a; }
        .summary-card.used { border-left: 4px solid #ef5350; }
        .summary-card.remain { border-left: 4px solid #ffa726; }
        .summary-card.count { border-left: 4px solid #ab47bc; }
        .summary-card.usage { border-left: 4px solid #ff7043; }
        .value.negative { color: #ef5350; }
        .value.warning { color: #ff9800; }
        .value.danger { color: #ef5350; }
        .usage-bar { height: 6px; background: #e0e0e0; border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .usage-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .alert-banner { background: #fff3e0; border: 1px solid #ffcc80; color: #e65100; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; }
        .alert-banner.danger { background: #ffebee; border-color: #ef9a9a; color: #c62828; }
        .alert-banner .icon { font-size: 20px; }

        .budget-edit { background: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .budget-edit h3 { font-size: 14px; color: #555; margin-bottom: 12px; }
        .budget-form { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .budget-form .form-group { display: flex; flex-direction: column; gap: 4px; }
        .budget-form label { font-size: 12px; font-weight: 600; color: #666; }
        .budget-form input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 160px; }
        .btn-budget { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }

        .charts-row { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); flex: 1; min-width: 0; }
        .chart-container.bar-chart { flex: 2; height: 300px; min-width: 500px; }
        .chart-container.pie-charts { flex: 1; display: flex; gap: 12px; min-width: 300px; height: 300px; }
        .pie-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .pie-wrap canvas { width: 100% !important; height: 100% !important; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        th { background: #333; color: white; padding: 12px 16px; text-align: left; font-size: 13px; }
        td { padding: 10px 16px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        tr:hover { background: #f8f9ff; }
        .amount { text-align: right; font-weight: 600; }
        .badge { display: inline-block; padding: 4px 14px; border-radius: 4px; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; min-width: 60px; text-align: center; }
        .badge-link { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .badge-bugs { background: #fce4ec; color: #c62828; border: 1px solid #ef9a9a; }
        .actions { display: flex; gap: 6px; }
        .btn-sm { padding: 4px 10px; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; font-size: 12px; }
        .btn-edit { background: #2196F3; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .btn-sm:hover { opacity: 0.85; }
        .empty { text-align: center; padding: 60px; color: #999; }

        th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 24px; }
        th.sortable:hover { background: #444; }
        th.sortable::after { content: '\2195'; position: absolute; right: 8px; opacity: 0.4; font-size: 12px; }
        th.sortable.asc::after { content: '\25B2'; opacity: 1; font-size: 10px; }
        th.sortable.desc::after { content: '\25BC'; opacity: 1; font-size: 10px; }

        /* ë‹¤í¬ ëª¨ë“œ í† ê¸€ */
        .theme-toggle { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); }

        /* ë‹¤í¬ ëª¨ë“œ */
        body.dark { background: #1a1a2e; color: #e0e0e0; }
        body.dark .filter-bar, body.dark .summary-card, body.dark .chart-container, body.dark .budget-edit, body.dark .panel { background: #16213e; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        body.dark table { background: #16213e; }
        body.dark th { background: #0f3460; color: #e0e0e0; }
        body.dark td { border-bottom-color: #1a1a3e; color: #e0e0e0; }
        body.dark tr:hover { background: #1a1a3e; }
        body.dark .filter-group label { color: #aaa; }
        body.dark .filter-group select, body.dark .ym-dropdown-btn, body.dark input[type="text"] { background: #0f3460; color: #e0e0e0; border-color: #333; }
        body.dark .ym-dropdown-list { background: #16213e; border-color: #333; }
        body.dark .ym-dropdown-list label:hover { background: #1a1a3e; }
        body.dark .summary-card .label { color: #999; }
        body.dark .summary-card .value { color: #e0e0e0; }
        body.dark .empty { color: #666; }
        body.dark .alert-banner { background: #2a1a00; border-color: #664400; color: #ffcc80; }
        body.dark .alert-banner.danger { background: #2a0000; border-color: #660000; color: #ef9a9a; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header { padding: 12px 16px; flex-direction: column; gap: 8px; }
            .header h1 { font-size: 16px; }
            .header-right { flex-wrap: wrap; justify-content: center; gap: 8px; font-size: 12px; }
            .container { padding: 0 12px; margin: 12px auto; }
            .filter-bar { flex-direction: column; gap: 8px; padding: 12px; }
            .filter-group { width: 100%; }
            .filter-group select, .ym-dropdown-btn { width: 100%; }
            .btn-group-right { margin-left: 0; width: 100%; flex-wrap: wrap; }
            .btn-add { flex: 1; text-align: center; }
            .summary { flex-direction: column; }
            .summary-card { min-width: auto; }
            .charts-row { flex-direction: column; }
            .chart-container.bar-chart, .chart-container.pie-charts { flex: none; width: 100%; min-width: auto; }
            .chart-container.pie-charts { flex-direction: column; height: auto; }
            .chart-container.bar-chart { height: 250px; min-width: auto; }
            .pie-wrap { height: 200px; }
            table { font-size: 12px; display: block; overflow-x: auto; white-space: nowrap; }
            th, td { padding: 8px 10px; }
            .actions { flex-direction: column; gap: 4px; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1><a href="/" style="color:white; text-decoration:none;">NHN ê²½ë¹„ ê´€ë¦¬</a></h1>
    <div class="header-right">
        <div class="nav-links">
            <a href="/" class="nav-link">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/expenses" class="nav-link active">ê²½ë¹„</a>
            <a href="/monitor" class="nav-link" sec:authorize="hasRole('ADMIN')">ëª¨ë‹ˆí„°ë§</a>
            <a href="/admin/users" class="nav-link" sec:authorize="hasRole('ADMIN')">ì‚¬ìš©ì</a>
        </div>
        <span sec:authentication="name"></span>
        <button class="theme-toggle" onclick="toggleDarkMode()" id="themeBtn">ğŸŒ™</button>
        <a th:href="@{/change-password}" class="btn-logout">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
        <form th:action="@{/logout}" method="post" style="display:inline; margin:0;">
            <button type="submit" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
    </div>
</div>

<div class="container">
    <!-- í•„í„° -->
    <form class="filter-bar" th:action="@{/expenses}" method="get">
        <div class="filter-group">
            <label>ë…„ì›”</label>
            <div class="ym-dropdown" id="ymDropdown">
                <button type="button" class="ym-dropdown-btn" id="ymDropdownBtn">ì „ì²´</button>
                <div class="ym-dropdown-list" id="ymDropdownList">
                    <label class="all-label"><input type="checkbox" id="ymAll" checked> ì „ì²´</label>
                    <th:block th:each="y : ${ymList}">
                        <label><input type="checkbox" name="ym" th:value="${y}" th:checked="${selectedYmList.contains(y)}" class="ym-cb"> <span th:text="${y}"></span></label>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="filter-group" th:with="catLocked=${userRole != 'ROLE_ADMIN'}">
            <label>íšŒì‚¬</label>
            <select name="category" id="catSelect" th:disabled="${catLocked}">
                <option value="">ì „ì²´</option>
                <option th:each="c : ${categoryList}" th:value="${c}" th:text="${c}" th:selected="${c == selectedCategory}"></option>
            </select>
            <input th:if="${catLocked}" type="hidden" name="category" th:value="${selectedCategory}"/>
        </div>
        <div class="filter-group">
            <label>ê³„ì •</label>
            <div class="ym-dropdown" id="divDropdown">
                <button type="button" class="ym-dropdown-btn" id="divDropdownBtn">ì „ì²´</button>
                <div class="ym-dropdown-list" id="divDropdownList">
                    <label class="all-label"><input type="checkbox" id="divAll" checked> ì „ì²´</label>
                    <th:block th:each="d : ${divisionList}">
                        <label><input type="checkbox" name="division" th:value="${d}" th:checked="${selectedDivisionList.contains(d)}" class="div-cb"> <span th:text="${d}"></span></label>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="filter-group" th:with="deptLocked=${userRole == 'ROLE_DEPARTMENT' or userRole == 'ROLE_TEAM'}">
            <label>ì‹¤</label>
            <select name="department" id="deptSelect" th:disabled="${deptLocked}">
                <option value="">ì „ì²´</option>
                <option th:each="d : ${departmentList}" th:value="${d}" th:text="${d}" th:selected="${d == selectedDepartment}"></option>
            </select>
            <input th:if="${deptLocked}" type="hidden" name="department" th:value="${selectedDepartment}"/>
        </div>
        <div class="filter-group">
            <label>íŒ€</label>
            <div class="ym-dropdown" id="teamDropdown" th:with="isTeamRole=${userRole == 'ROLE_TEAM'}">
                <button type="button" class="ym-dropdown-btn" id="teamDropdownBtn">ì „ì²´</button>
                <div class="ym-dropdown-list" id="teamDropdownList" th:unless="${isTeamRole}">
                    <label class="all-label"><input type="checkbox" id="teamAll" checked> ì „ì²´</label>
                    <label><input type="checkbox" name="team" value="__DEPT_ONLY__" th:checked="${selectedTeamList.contains('__DEPT_ONLY__')}" class="team-cb"> ì‹¤(ìì²´)</label>
                    <th:block th:each="t : ${teamList}">
                        <label><input type="checkbox" name="team" th:value="${t}" th:checked="${selectedTeamList.contains(t)}" class="team-cb"> <span th:text="${t}"></span></label>
                    </th:block>
                </div>
                <input th:if="${isTeamRole}" type="hidden" name="team" th:value="${userTeam}"/>
            </div>
        </div>
        <div class="filter-group">
            <label>ìƒì„¸ì¡°ê±´</label>
            <div style="display:flex; gap:4px;">
                <select name="searchType" style="min-width:80px; height:34px; padding:7px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                    <option value="storeName" th:selected="${selectedSearchType == 'storeName'}">ìƒí˜¸</option>
                    <option value="purpose" th:selected="${selectedSearchType == 'purpose'}">ë‚´ìš©</option>
                </select>
                <input type="text" name="searchKeyword" th:value="${selectedSearchKeyword}" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" style="width:150px; padding:7px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; height:34px;">
            </div>
        </div>
        <button type="submit" class="btn-filter">ì¡°íšŒ</button>
        <a th:href="@{/expenses}" class="btn-reset">ì´ˆê¸°í™”</a>
    </form>

    <!-- ì˜ˆì‚° ì´ˆê³¼/ê²½ê³  ë°°ë„ˆ -->
    <div th:if="${usagePercent >= 100}" class="alert-banner danger">
        <span class="icon">&#9888;</span> ì˜ˆì‚°ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤! (ì‚¬ìš©ë¥  <span th:text="${usagePercent}"></span>%)
    </div>
    <div th:if="${usagePercent >= 80 and usagePercent < 100}" class="alert-banner">
        <span class="icon">&#9888;</span> ì˜ˆì‚° ì‚¬ìš©ë¥ ì´ <span th:text="${usagePercent}"></span>%ì…ë‹ˆë‹¤. ì£¼ì˜í•´ì£¼ì„¸ìš”!
    </div>

    <!-- ì˜ˆì‚° ìš”ì•½ -->
    <div class="summary">
        <div class="summary-card budget-total">
            <div class="label">ì˜ˆì‚° í•©ê³„</div>
            <div class="value" th:text="${#numbers.formatDecimal(budgetTotal, 0, 'COMMA', 0, 'POINT')} + ' ì›'"></div>
        </div>
        <div class="summary-card monthly">
            <div class="label">ê¸ˆì›” ì˜ˆì‚°</div>
            <div class="value" th:text="${#numbers.formatDecimal(monthlyAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'"></div>
        </div>
        <div class="summary-card prev">
            <div class="label">ì „ì›” ì”ì—¬</div>
            <div class="value" th:text="${#numbers.formatDecimal(prevRemaining, 0, 'COMMA', 0, 'POINT')} + ' ì›'"></div>
        </div>
        <div class="summary-card used">
            <div class="label">ì‚¬ìš© ê¸ˆì•¡</div>
            <div class="value" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ì›'"></div>
        </div>
        <div class="summary-card remain">
            <div class="label">ê¸ˆì›” ì”ì•¡</div>
            <div class="value" th:classappend="${remaining.signum() < 0 ? 'negative' : ''}" th:text="${#numbers.formatDecimal(remaining, 0, 'COMMA', 0, 'POINT')} + ' ì›'"></div>
        </div>
        <div class="summary-card usage">
            <div class="label">ì‚¬ìš©ë¥ </div>
            <div class="value" th:classappend="${usagePercent >= 100 ? 'danger' : (usagePercent >= 80 ? 'warning' : '')}" th:text="${usagePercent} + '%'"></div>
            <div class="usage-bar">
                <div class="usage-bar-fill" th:style="'width:' + ${usagePercent > 100 ? 100 : usagePercent} + '%; background:' + ${usagePercent >= 100 ? '#ef5350' : (usagePercent >= 80 ? '#ff9800' : '#66bb6a')}"></div>
            </div>
        </div>
        <div class="summary-card count">
            <div class="label">ê±´ìˆ˜</div>
            <div class="value" th:text="${totalCount} + ' ê±´'"></div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="charts-row">
        <div class="chart-container bar-chart" th:if="${chartLabels.size() > 0}">
            <canvas id="monthlyChart" style="width:100%; height:100%;"></canvas>
        </div>
        <div class="chart-container pie-charts" th:if="${!expenses.isEmpty()}">
            <div class="pie-wrap">
                <canvas id="catPieChart"></canvas>
            </div>
            <div class="pie-wrap">
                <canvas id="divPieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ê²½ë¹„ ë¦¬ìŠ¤íŠ¸ í—¤ë” -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <span style="font-size:13px; color:#666;">ì¡°íšŒ ê²°ê³¼: <strong th:text="${totalCount}"></strong>ê±´ | í•©ê³„: <strong th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')}"></strong>ì›</span>
        <div style="display:flex; gap:6px;">
            <a th:href="@{/expenses/new}" class="btn-add">+ ê²½ë¹„</a>
            <a th:href="@{/expenses/budget/new}" class="btn-add" style="background:#667eea;">+ ì˜ˆì‚°</a>
            <a id="downloadBtn" href="#" class="btn-add" style="background:#ff9800;" onclick="doDownload(event)">ë‹¤ìš´ë¡œë“œ</a>
            <a th:href="@{/expenses/upload}" class="btn-add" style="background:#2196F3;">ì—…ë¡œë“œ</a>
        </div>
    </div>
    <table th:if="${!expenses.isEmpty()}">
        <thead>
        <tr>
            <th class="sortable" data-col="0" data-type="text">ë‚ ì§œ</th>
            <th class="sortable" data-col="1" data-type="text">íšŒì‚¬</th>
            <th class="sortable" data-col="2" data-type="text">ì‹¤</th>
            <th class="sortable" data-col="3" data-type="text">íŒ€</th>
            <th class="sortable" data-col="4" data-type="text">ê³„ì •</th>
            <th>ë‚´ìš©</th>
            <th class="sortable" data-col="6" data-type="text">ìƒí˜¸</th>
            <th class="amount">ê¸ˆì•¡</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="exp : ${expenses}">
            <td th:text="${exp.expenseDate}"></td>
            <td>
                <span class="badge" th:classappend="${exp.category == 'LINK' ? 'badge-link' : 'badge-bugs'}" th:text="${exp.category}"></span>
            </td>
            <td th:text="${exp.department}"></td>
            <td th:text="${exp.team}"></td>
            <td th:text="${exp.division}"></td>
            <td th:text="${exp.purpose}"></td>
            <td th:text="${exp.storeName}"></td>
            <td class="amount" th:text="${#numbers.formatDecimal(exp.amount, 0, 'COMMA', 0, 'POINT')}"></td>
            <td>
                <div class="actions">
                    <a th:href="@{/expenses/{id}/edit(id=${exp.id})}" class="btn-sm btn-edit filter-link">ìˆ˜ì •</a>
                    <a th:href="@{/expenses/{id}/delete(id=${exp.id})}" class="btn-sm btn-delete filter-link"
                       onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <div th:if="${expenses.isEmpty()}" class="empty">
        <p>ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- ì˜ˆì‚° ëª©ë¡ -->
    <div th:if="${!budgetList.isEmpty()}" style="margin-top: 24px;">
        <h3 style="color: #555; margin-bottom: 12px; font-size: 15px;">ì˜ˆì‚° í˜„í™©</h3>
        <table>
            <thead>
            <tr>
                <th>ë…„ì›”</th>
                <th>íšŒì‚¬</th>
                <th>ê³„ì •</th>
                <th>ì‹¤</th>
                <th>íŒ€</th>
                <th class="amount">ê¸ˆì›” ì˜ˆì‚°</th>
                <th class="amount">ì „ì›” ì”ì—¬</th>
                <th class="amount">ì˜ˆì‚° í•©ê³„</th>
                <th class="amount">ì‚¬ìš©ê¸ˆì•¡</th>
                <th class="amount">ê¸ˆì›” ì”ì•¡</th>
                <th>ì‚¬ìš©ë¥ </th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="b : ${budgetList}">
                <td th:text="${b.ym}"></td>
                <td>
                    <span class="badge" th:classappend="${b.category == 'LINK' ? 'badge-link' : 'badge-bugs'}" th:text="${b.category}"></span>
                </td>
                <td th:text="${b.division}"></td>
                <td th:text="${b.department}"></td>
                <td th:text="${b.team}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(b.monthlyAmount, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(b.prevRemaining, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(b.totalBudget, 0, 'COMMA', 0, 'POINT')}"></td>
                <th:block th:with="budgetKey=${b.ym + '_' + b.category + '_' + b.division + '_' + (b.department != null ? b.department : '') + '_' + (b.team != null ? b.team : '')}, used=${usedAmountMap.containsKey(budgetKey) ? usedAmountMap.get(budgetKey) : T(java.math.BigDecimal).ZERO}, balance=${b.totalBudget.subtract(used)}, bUsage=${budgetUsageMap.containsKey(budgetKey) ? budgetUsageMap.get(budgetKey) : 0}">
                <td class="amount" th:text="${#numbers.formatDecimal(used, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:classappend="${balance.signum() lt 0 ? ' negative' : ''}" th:text="${#numbers.formatDecimal(balance, 0, 'COMMA', 0, 'POINT')}"></td>
                <td>
                    <span th:classappend="${bUsage >= 100 ? 'danger' : (bUsage >= 80 ? 'warning' : '')}" th:text="${bUsage} + '%'" style="font-weight:600; font-size:13px;"></span>
                </td>
                </th:block>
                <td>
                    <div class="actions" th:if="${isAdmin or (b.department == userDepartment and b.team == userTeam)}">
                        <a th:href="@{/expenses/budget/{id}/edit(id=${b.id})}" class="btn-sm btn-edit filter-link">ìˆ˜ì •</a>
                        <a th:if="${isAdmin}" th:href="@{/expenses/budget/{id}/delete(id=${b.id})}" class="btn-sm btn-delete filter-link"
                           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                    </div>
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr style="background:#f5f5f5; font-weight:700;">
                <td colspan="5" style="text-align:center;">í•©ê³„</td>
                <td class="amount" th:text="${#numbers.formatDecimal(monthlyAmount, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(prevRemaining, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(budgetTotal, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:classappend="${remaining.signum() lt 0 ? ' negative' : ''}" th:text="${#numbers.formatDecimal(remaining, 0, 'COMMA', 0, 'POINT')}"></td>
                <td><span th:classappend="${usagePercent >= 100 ? 'danger' : (usagePercent >= 80 ? 'warning' : '')}" th:text="${usagePercent} + '%'" style="font-weight:700; font-size:13px;"></span></td>
                <td></td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
// ë‹¤í¬ ëª¨ë“œ
function toggleDarkMode() {
    var isDark = document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    document.getElementById('themeBtn').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
}
(function() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('themeBtn').textContent = 'â˜€ï¸';
    }
})();

// ë‹¤ìš´ë¡œë“œ: í˜„ì¬ í¼ì˜ í•„í„° ì¡°ê±´ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
function doDownload(e) {
    e.preventDefault();
    var form = document.querySelector('.filter-bar');
    var params = new URLSearchParams(new FormData(form));
    window.location.href = '/expenses/download?' + params.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    // ======== ì›” ì²´í¬ë°•ìŠ¤ ë“œë¡­ë‹¤ìš´ ========
    var btn = document.getElementById('ymDropdownBtn');
    var list = document.getElementById('ymDropdownList');
    var allCb = document.getElementById('ymAll');
    var ymCbs = document.querySelectorAll('.ym-cb');

    function updateBtnText() {
        var checked = Array.from(ymCbs).filter(function(c) { return c.checked; });
        if (checked.length === 0 || checked.length === ymCbs.length) {
            btn.textContent = 'ì „ì²´';
            allCb.checked = true;
        } else if (checked.length === 1) {
            btn.textContent = checked[0].value;
            allCb.checked = false;
        } else {
            btn.textContent = checked[0].value + ' ì™¸ ' + (checked.length - 1) + 'ê±´';
            allCb.checked = false;
        }
    }

    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    var hasSelected = Array.from(ymCbs).some(function(c) { return c.checked; });
    if (!hasSelected) {
        allCb.checked = true;
    } else {
        allCb.checked = (Array.from(ymCbs).filter(function(c) { return c.checked; }).length === ymCbs.length);
    }
    updateBtnText();

    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        list.classList.toggle('open');
        divList.classList.remove('open');
        if (teamListEl) teamListEl.classList.remove('open');
    });

    document.addEventListener('click', function(e) {
        if (!document.getElementById('ymDropdown').contains(e.target)) {
            list.classList.remove('open');
        }
        if (!document.getElementById('divDropdown').contains(e.target)) {
            divList.classList.remove('open');
        }
        var teamDd = document.getElementById('teamDropdown');
        if (teamDd && !teamDd.contains(e.target) && teamListEl) {
            teamListEl.classList.remove('open');
        }
    });

    allCb.addEventListener('change', function() {
        ymCbs.forEach(function(c) { c.checked = allCb.checked; });
        updateBtnText();
    });

    ymCbs.forEach(function(cb) {
        cb.addEventListener('change', function() {
            var allChecked = Array.from(ymCbs).every(function(c) { return c.checked; });
            var noneChecked = Array.from(ymCbs).every(function(c) { return !c.checked; });
            allCb.checked = allChecked || noneChecked;
            if (noneChecked) {
                ymCbs.forEach(function(c) { c.checked = false; });
            }
            updateBtnText();
        });
    });

    // ======== êµ¬ë¶„ ì²´í¬ë°•ìŠ¤ ë“œë¡­ë‹¤ìš´ ========
    var divBtn = document.getElementById('divDropdownBtn');
    var divList = document.getElementById('divDropdownList');
    var divAll = document.getElementById('divAll');
    var divCbs = document.querySelectorAll('.div-cb');

    function updateDivBtnText() {
        var checked = Array.from(divCbs).filter(function(c) { return c.checked; });
        if (checked.length === 0 || checked.length === divCbs.length) {
            divBtn.textContent = 'ì „ì²´';
            divAll.checked = true;
        } else if (checked.length === 1) {
            divBtn.textContent = checked[0].value;
            divAll.checked = false;
        } else {
            divBtn.textContent = checked[0].value + ' ì™¸ ' + (checked.length - 1) + 'ê±´';
            divAll.checked = false;
        }
    }

    var divHasSelected = Array.from(divCbs).some(function(c) { return c.checked; });
    if (!divHasSelected) {
        divAll.checked = true;
    } else {
        divAll.checked = (Array.from(divCbs).filter(function(c) { return c.checked; }).length === divCbs.length);
    }
    updateDivBtnText();

    divBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        divList.classList.toggle('open');
        list.classList.remove('open');
        if (teamListEl) teamListEl.classList.remove('open');
    });

    divAll.addEventListener('change', function() {
        divCbs.forEach(function(c) { c.checked = divAll.checked; });
        updateDivBtnText();
    });

    divCbs.forEach(function(cb) {
        cb.addEventListener('change', function() {
            var allChecked = Array.from(divCbs).every(function(c) { return c.checked; });
            var noneChecked = Array.from(divCbs).every(function(c) { return !c.checked; });
            divAll.checked = allChecked || noneChecked;
            if (noneChecked) {
                divCbs.forEach(function(c) { c.checked = false; });
            }
            updateDivBtnText();
        });
    });

    // ======== íŒ€ ì²´í¬ë°•ìŠ¤ ë“œë¡­ë‹¤ìš´ ========
    var teamBtn = document.getElementById('teamDropdownBtn');
    var teamListEl = document.getElementById('teamDropdownList');
    var teamAll = document.getElementById('teamAll');
    var teamCbs = document.querySelectorAll('.team-cb');

    if (teamBtn && teamListEl && teamAll) {
        function updateTeamBtnText() {
            var checked = Array.from(teamCbs).filter(function(c) { return c.checked; });
            if (checked.length === 0 || checked.length === teamCbs.length) {
                teamBtn.textContent = 'ì „ì²´';
                teamAll.checked = true;
            } else if (checked.length === 1) {
                var v = checked[0].value === '__DEPT_ONLY__' ? 'ì‹¤(ìì²´)' : checked[0].value;
                teamBtn.textContent = v;
                teamAll.checked = false;
            } else {
                var first = checked[0].value === '__DEPT_ONLY__' ? 'ì‹¤(ìì²´)' : checked[0].value;
                teamBtn.textContent = first + ' ì™¸ ' + (checked.length - 1) + 'ê±´';
                teamAll.checked = false;
            }
        }

        var teamHasSelected = Array.from(teamCbs).some(function(c) { return c.checked; });
        if (!teamHasSelected) {
            teamAll.checked = true;
        } else {
            teamAll.checked = (Array.from(teamCbs).filter(function(c) { return c.checked; }).length === teamCbs.length);
        }
        updateTeamBtnText();

        teamBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            teamListEl.classList.toggle('open');
            list.classList.remove('open');
            divList.classList.remove('open');
        });

        document.addEventListener('click', function(e) {
            if (!document.getElementById('teamDropdown').contains(e.target)) {
                teamListEl.classList.remove('open');
            }
        });

        teamAll.addEventListener('change', function() {
            teamCbs.forEach(function(c) { c.checked = teamAll.checked; });
            updateTeamBtnText();
        });

        teamCbs.forEach(function(cb) {
            cb.addEventListener('change', function() {
                var allChecked = Array.from(teamCbs).every(function(c) { return c.checked; });
                var noneChecked = Array.from(teamCbs).every(function(c) { return !c.checked; });
                teamAll.checked = allChecked || noneChecked;
                if (noneChecked) {
                    teamCbs.forEach(function(c) { c.checked = false; });
                }
                updateTeamBtnText();
            });
        });
    } else if (teamBtn) {
        // ROLE_TEAM: íŒ€ ê³ ì • í‘œì‹œ
        var fixedTeam = document.querySelector('input[type="hidden"][name="team"]');
        if (fixedTeam) teamBtn.textContent = fixedTeam.value || 'ì „ì²´';
    }

    // ======== íšŒì‚¬â†’ì‹¤â†’íŒ€ ìºìŠ¤ì¼€ì´ë”© í•„í„° ========
    var COMPANY_DEPT_MAP = {
        'BUGS': ['BUGSê°œë°œì‹¤'],
        'LINK': ['LINKê°œë°œì‹¤']
    };
    var DEPT_TEAM_MAP = {
        'BUGSê°œë°œì‹¤': ['ë°±ì•¤ë“œê°œë°œíŒ€', 'í”„ë¡ íŠ¸ê°œë°œíŒ€'],
        'LINKê°œë°œì‹¤': ['ì„œë¹„ìŠ¤ê°œë°œíŒ€', 'ìš´ì˜ê°œë°œíŒ€']
    };

    var catSelect = document.getElementById('catSelect');
    var deptSelect = document.getElementById('deptSelect');

    function filterDeptOptions() {
        if (!deptSelect || deptSelect.disabled) return;
        var selCat = catSelect ? catSelect.value : '';
        var allowedDepts = selCat && COMPANY_DEPT_MAP[selCat] ? COMPANY_DEPT_MAP[selCat] : null;
        Array.from(deptSelect.options).forEach(function(opt) {
            if (opt.value === '') { opt.style.display = ''; return; }
            opt.style.display = (!allowedDepts || allowedDepts.indexOf(opt.value) >= 0) ? '' : 'none';
        });
        // ì„ íƒëœ ì‹¤ì´ í—ˆìš© ë²”ìœ„ ë°–ì´ë©´ ì´ˆê¸°í™”
        if (allowedDepts && deptSelect.value && allowedDepts.indexOf(deptSelect.value) < 0) {
            deptSelect.value = '';
        }
    }

    function filterTeamOptions() {
        if (!teamListEl) return;
        var selDept = deptSelect ? deptSelect.value : '';
        var selCat = catSelect ? catSelect.value : '';
        // ì‹¤ì´ ì„ íƒë˜ë©´ í•´ë‹¹ ì‹¤ í•˜ìœ„ íŒ€ë§Œ, íšŒì‚¬ë§Œ ì„ íƒë˜ë©´ íšŒì‚¬ í•˜ìœ„ ì „ì²´ íŒ€
        var allowedTeams = null;
        if (selDept && DEPT_TEAM_MAP[selDept]) {
            allowedTeams = DEPT_TEAM_MAP[selDept];
        } else if (selCat && COMPANY_DEPT_MAP[selCat]) {
            allowedTeams = [];
            COMPANY_DEPT_MAP[selCat].forEach(function(d) {
                if (DEPT_TEAM_MAP[d]) allowedTeams = allowedTeams.concat(DEPT_TEAM_MAP[d]);
            });
        }
        teamCbs = document.querySelectorAll('.team-cb');
        teamCbs.forEach(function(cb) {
            var lbl = cb.closest('label');
            if (cb.value === '__DEPT_ONLY__') { lbl.style.display = ''; return; }
            if (!allowedTeams) { lbl.style.display = ''; return; }
            lbl.style.display = allowedTeams.indexOf(cb.value) >= 0 ? '' : 'none';
            if (allowedTeams.indexOf(cb.value) < 0) cb.checked = false;
        });
        if (typeof updateTeamBtnText === 'function') updateTeamBtnText();
    }

    if (catSelect) {
        catSelect.addEventListener('change', function() {
            filterDeptOptions();
            filterTeamOptions();
        });
    }
    if (deptSelect) {
        deptSelect.addEventListener('change', function() {
            filterTeamOptions();
        });
    }
    // ì´ˆê¸° ë¡œë“œ ì‹œ ì ìš©
    filterDeptOptions();
    filterTeamOptions();

    // ======== ì •ë ¬ ========
    function sortByCol(th, dir) {
        var table = th.closest('table');
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var col = parseInt(th.dataset.col);

        table.querySelectorAll('th.sortable').forEach(function(h) {
            h.classList.remove('asc', 'desc');
        });
        th.classList.add(dir);

        rows.sort(function(a, b) {
            var aText = a.cells[col].textContent.trim();
            var bText = b.cells[col].textContent.trim();
            var cmp = aText.localeCompare(bText, 'ko');
            return dir === 'asc' ? cmp : -cmp;
        });

        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    document.querySelectorAll('th.sortable').forEach(function(th) {
        th.addEventListener('click', function() {
            var isAsc = th.classList.contains('asc');
            sortByCol(th, isAsc ? 'desc' : 'asc');
        });
    });

    // ë‚ ì§œ ì»¬ëŸ¼ ì´ˆê¸° ì •ë ¬: desc
    var dateTh = document.querySelector('th.sortable[data-col="0"]');
    if (dateTh) sortByCol(dateTh, 'desc');

    // ======== ìˆ˜ì •/ì‚­ì œ ë§í¬ì— í˜„ì¬ í•„í„° ì¡°ê±´ ì „ë‹¬ ========
    function getCurrentFilter() {
        var form = document.querySelector('.filter-bar');
        var params = new URLSearchParams(new FormData(form));
        return params.toString();
    }

    document.querySelectorAll('.filter-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            var filter = getCurrentFilter();
            var href = link.getAttribute('href');
            var sep = href.indexOf('?') >= 0 ? '&' : '?';
            link.setAttribute('href', href + sep + 'returnFilter=' + encodeURIComponent(filter));
        });
    });
});
</script>
<script th:inline="javascript">
// ======== ì›”ë³„ ì‚¬ìš©ê¸ˆì•¡/ì”ì—¬ê¸ˆì•¡ ì°¨íŠ¸ ========
(function() {
    var chartEl = document.getElementById('monthlyChart');
    if (!chartEl) return;
    var labels = /*[[${chartLabels}]]*/ [];
    var usedValues = /*[[${chartUsedValues}]]*/ [];
    var remainValues = /*[[${chartRemainValues}]]*/ [];
    var prevYearValues = /*[[${chartPrevYearValues}]]*/ [];
    var selectedYmList = /*[[${selectedYmList}]]*/ [];
    var hasSearchKeyword = /*[[${hasSearchKeyword}]]*/ false;
    var usedBg = labels.map(function(lbl) {
        return selectedYmList.indexOf(lbl) >= 0 ? '#ef5350' : '#f5b7b7';
    });
    var remainBg = labels.map(function(lbl) {
        return selectedYmList.indexOf(lbl) >= 0 ? '#66bb6a' : '#c0e6c2';
    });
    var datasets = [
        {
            label: 'ì‚¬ìš©ê¸ˆì•¡',
            data: usedValues,
            backgroundColor: usedBg,
            borderRadius: 4,
            maxBarThickness: 40
        }
    ];
    // ìƒì„¸ì¡°ê±´(ê²€ìƒ‰ì–´) ì—†ì„ ë•Œë§Œ ì”ì—¬ê¸ˆì•¡ í‘œì‹œ
    if (!hasSearchKeyword) {
        datasets.push({
            label: 'ì”ì—¬ê¸ˆì•¡',
            data: remainValues,
            backgroundColor: remainBg,
            borderRadius: 4,
            maxBarThickness: 40
        });
    }
    datasets.push({
        label: 'ì „ë…„ ë™ì›”',
        data: prevYearValues,
        type: 'line',
        borderColor: '#9e9e9e',
        borderDash: [5, 5],
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: '#9e9e9e',
        fill: false,
        tension: 0.3
    });
    new Chart(chartEl, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { font: { family: 'Pretendard', size: 12 }, usePointStyle: true, pointStyle: 'rectRounded', padding: 16 }
                },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            return ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('ko-KR') + ' ì›';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(v) { return v.toLocaleString('ko-KR'); },
                        font: { family: 'Pretendard', size: 11 }
                    },
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    ticks: {
                        font: function(ctx) {
                            var lbl = labels[ctx.index];
                            var isSel = selectedYmList.indexOf(lbl) >= 0;
                            return { family: 'Pretendard', size: isSel ? 13 : 11, weight: isSel ? 'bold' : 'normal' };
                        },
                        color: function(ctx) {
                            var lbl = labels[ctx.index];
                            return selectedYmList.indexOf(lbl) >= 0 ? '#333' : '#999';
                        }
                    },
                    grid: { display: false }
                }
            }
        }
    });
})();

// ======== ì¹´í…Œê³ ë¦¬ë³„ íŒŒì´ ì°¨íŠ¸ ========
(function() {
    var catEl = document.getElementById('catPieChart');
    if (!catEl) return;
    var pieLabels = /*[[${pieLabels}]]*/ [];
    var pieValues = /*[[${pieValues}]]*/ [];
    var catColors = { 'LINK': '#42a5f5', 'BUGS': '#ef5350' };
    var bgColors = pieLabels.map(function(l) { return catColors[l] || '#bdbdbd'; });
    new Chart(catEl, {
        type: 'doughnut',
        data: { labels: pieLabels, datasets: [{ data: pieValues, backgroundColor: bgColors, borderWidth: 2, borderColor: '#fff' }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'íšŒì‚¬ë³„', font: { family: 'Pretendard', size: 13, weight: 'bold' } },
                legend: { position: 'bottom', labels: { font: { family: 'Pretendard', size: 11 }, padding: 8, usePointStyle: true } },
                tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + ctx.parsed.toLocaleString('ko-KR') + ' ì›'; } } }
            }
        }
    });
})();

// ======== êµ¬ë¶„ë³„ íŒŒì´ ì°¨íŠ¸ ========
(function() {
    var divEl = document.getElementById('divPieChart');
    if (!divEl) return;
    var pieDivLabels = /*[[${pieDivLabels}]]*/ [];
    var pieDivValues = /*[[${pieDivValues}]]*/ [];
    var divColors = ['#667eea','#66bb6a','#ffa726','#ab47bc','#26c6da','#ef5350','#8d6e63'];
    new Chart(divEl, {
        type: 'doughnut',
        data: { labels: pieDivLabels, datasets: [{ data: pieDivValues, backgroundColor: divColors.slice(0, pieDivLabels.length), borderWidth: 2, borderColor: '#fff' }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'ê³„ì •ë³„', font: { family: 'Pretendard', size: 13, weight: 'bold' } },
                legend: { position: 'bottom', labels: { font: { family: 'Pretendard', size: 11 }, padding: 8, usePointStyle: true } },
                tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + ctx.parsed.toLocaleString('ko-KR') + ' ì›'; } } }
            }
        }
    });
})();
</script>
</body>
</html>
