<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHN Í≤ΩÎπÑ Í¥ÄÎ¶¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; }

        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 40px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 16px; font-size: 14px; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 13px; }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        .nav-links { display: flex; gap: 12px; }
        .nav-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 13px; padding: 4px 10px; border-radius: 4px; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.2); }

        .container { max-width: 1200px; margin: 24px auto; padding: 0 20px; }

        .filter-bar { background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 20px; display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; }
        .filter-group label { font-size: 11px; font-weight: 600; color: #666; }
        .filter-group select { padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-width: 110px; height: 34px; }

        .ym-dropdown { position: relative; }
        .ym-dropdown-btn { padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-width: 110px; height: 34px; background: white; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .ym-dropdown-btn::after { content: '\25BC'; font-size: 9px; color: #999; margin-left: 8px; }
        .ym-dropdown-list { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); z-index: 100; min-width: 160px; max-height: 280px; overflow-y: auto; margin-top: 2px; }
        .ym-dropdown-list.open { display: block; }
        .ym-dropdown-list label { display: flex; align-items: center; gap: 8px; padding: 7px 12px; cursor: pointer; font-size: 13px; font-weight: 400; margin: 0; }
        .ym-dropdown-list label:hover { background: #f5f5ff; }
        .ym-dropdown-list label.all-label { border-bottom: 1px solid #eee; font-weight: 600; }
        .ym-dropdown-list input[type="checkbox"] { accent-color: #667eea; }
        .btn-filter { padding: 0 16px; height: 34px; line-height: 34px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: inherit; display: inline-flex; align-items: center; }
        .btn-filter:hover { background: #5a6fd6; }
        .btn-reset { padding: 0 12px; height: 34px; line-height: 34px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; text-decoration: none; display: inline-flex; align-items: center; }
        .btn-group-right { display: flex; gap: 6px; margin-left: auto; flex-shrink: 0; }
        .btn-add { padding: 7px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; text-decoration: none; white-space: nowrap; }
        .btn-add:hover { background: #43a047; }

        .summary { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-card { background: white; padding: 16px 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); flex: 1; min-width: 150px; }
        .summary-card .label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .summary-card .value { font-size: 18px; font-weight: 700; color: #333; }
        .summary-card.budget-total { border-left: 4px solid #667eea; }
        .summary-card.monthly { border-left: 4px solid #42a5f5; }
        .summary-card.prev { border-left: 4px solid #66bb6a; }
        .summary-card.used { border-left: 4px solid #ef5350; }
        .summary-card.remain { border-left: 4px solid #ffa726; }
        .summary-card.count { border-left: 4px solid #ab47bc; }
        .summary-card.usage { border-left: 4px solid #ff7043; }
        .value.negative { color: #ef5350; }
        .value.warning { color: #ff9800; }
        .value.danger { color: #ef5350; }
        .usage-bar { height: 6px; background: #e0e0e0; border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .usage-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .alert-banner { background: #fff3e0; border: 1px solid #ffcc80; color: #e65100; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; }
        .alert-banner.danger { background: #ffebee; border-color: #ef9a9a; color: #c62828; }
        .alert-banner .icon { font-size: 20px; }

        .budget-edit { background: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .budget-edit h3 { font-size: 14px; color: #555; margin-bottom: 12px; }
        .budget-form { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .budget-form .form-group { display: flex; flex-direction: column; gap: 4px; }
        .budget-form label { font-size: 12px; font-weight: 600; color: #666; }
        .budget-form input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 160px; }
        .btn-budget { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }

        .charts-row { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); flex: 1; min-width: 0; }
        .chart-container.bar-chart { flex: 2; height: 300px; min-width: 500px; }
        .chart-container.pie-charts { flex: 1; display: flex; gap: 12px; min-width: 300px; height: 300px; }
        .pie-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .pie-wrap canvas { width: 100% !important; height: 100% !important; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        th { background: #333; color: white; padding: 12px 16px; text-align: left; font-size: 13px; }
        td { padding: 10px 16px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        tr:hover { background: #f8f9ff; }
        .amount { text-align: right; font-weight: 600; }
        .badge { display: inline-block; padding: 4px 14px; border-radius: 4px; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; min-width: 60px; text-align: center; }
        .badge-link { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .badge-bugs { background: #fce4ec; color: #c62828; border: 1px solid #ef9a9a; }
        .actions { display: flex; gap: 6px; }
        .btn-sm { padding: 4px 10px; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; font-size: 12px; }
        .btn-edit { background: #2196F3; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .btn-sm:hover { opacity: 0.85; }
        .empty { text-align: center; padding: 60px; color: #999; }

        th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 24px; }
        th.sortable:hover { background: #444; }
        th.sortable::after { content: '\2195'; position: absolute; right: 8px; opacity: 0.4; font-size: 12px; }
        th.sortable.asc::after { content: '\25B2'; opacity: 1; font-size: 10px; }
        th.sortable.desc::after { content: '\25BC'; opacity: 1; font-size: 10px; }

        /* Îã§ÌÅ¨ Î™®Îìú ÌÜ†Í∏Ä */
        .theme-toggle { background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); }

        /* Îã§ÌÅ¨ Î™®Îìú */
        body.dark { background: #1a1a2e; color: #e0e0e0; }
        body.dark .filter-bar, body.dark .summary-card, body.dark .chart-container, body.dark .budget-edit, body.dark .panel { background: #16213e; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
        body.dark table { background: #16213e; }
        body.dark th { background: #0f3460; color: #e0e0e0; }
        body.dark td { border-bottom-color: #1a1a3e; color: #e0e0e0; }
        body.dark tr:hover { background: #1a1a3e; }
        body.dark .filter-group label { color: #aaa; }
        body.dark .filter-group select, body.dark .ym-dropdown-btn, body.dark input[type="text"] { background: #0f3460; color: #e0e0e0; border-color: #333; }
        body.dark .ym-dropdown-list { background: #16213e; border-color: #333; }
        body.dark .ym-dropdown-list label:hover { background: #1a1a3e; }
        body.dark .summary-card .label { color: #999; }
        body.dark .summary-card .value { color: #e0e0e0; }
        body.dark .empty { color: #666; }
        body.dark .alert-banner { background: #2a1a00; border-color: #664400; color: #ffcc80; }
        body.dark .alert-banner.danger { background: #2a0000; border-color: #660000; color: #ef9a9a; }

        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .header { padding: 12px 16px; flex-direction: column; gap: 8px; }
            .header h1 { font-size: 16px; }
            .header-right { flex-wrap: wrap; justify-content: center; gap: 8px; font-size: 12px; }
            .container { padding: 0 12px; margin: 12px auto; }
            .filter-bar { flex-direction: column; gap: 8px; padding: 12px; }
            .filter-group { width: 100%; }
            .filter-group select, .ym-dropdown-btn { width: 100%; }
            .btn-group-right { margin-left: 0; width: 100%; flex-wrap: wrap; }
            .btn-add { flex: 1; text-align: center; }
            .summary { flex-direction: column; }
            .summary-card { min-width: auto; }
            .charts-row { flex-direction: column; }
            .chart-container.bar-chart, .chart-container.pie-charts { flex: none; width: 100%; min-width: auto; }
            .chart-container.pie-charts { flex-direction: column; height: auto; }
            .chart-container.bar-chart { height: 250px; min-width: auto; }
            .pie-wrap { height: 200px; }
            table { font-size: 12px; display: block; overflow-x: auto; white-space: nowrap; }
            th, td { padding: 8px 10px; }
            .actions { flex-direction: column; gap: 4px; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1><a href="/" style="color:white; text-decoration:none;">NHN Í≤ΩÎπÑ Í¥ÄÎ¶¨</a></h1>
    <div class="header-right">
        <div class="nav-links">
            <a href="/" class="nav-link">ÎåÄÏãúÎ≥¥Îìú</a>
            <a href="/expenses" class="nav-link active">Í≤ΩÎπÑ</a>
            <a href="/monitor" class="nav-link" sec:authorize="hasRole('ADMIN')">Î™®ÎãàÌÑ∞ÎßÅ</a>
            <a href="/admin/users" class="nav-link" sec:authorize="hasRole('ADMIN')">ÏÇ¨Ïö©Ïûê</a>
        </div>
        <span sec:authentication="name"></span>
        <button class="theme-toggle" onclick="toggleDarkMode()" id="themeBtn">üåô</button>
        <a th:href="@{/change-password}" class="btn-logout">ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</a>
        <form th:action="@{/logout}" method="post" style="display:inline; margin:0;">
            <button type="submit" class="btn-logout">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </form>
    </div>
</div>

<div class="container">
    <!-- ÌïÑÌÑ∞ -->
    <form class="filter-bar" th:action="@{/expenses}" method="get">
        <div class="filter-group">
            <label>Ïõî</label>
            <div class="ym-dropdown" id="ymDropdown">
                <button type="button" class="ym-dropdown-btn" id="ymDropdownBtn">Ï†ÑÏ≤¥</button>
                <div class="ym-dropdown-list" id="ymDropdownList">
                    <label class="all-label"><input type="checkbox" id="ymAll" checked> Ï†ÑÏ≤¥</label>
                    <th:block th:each="y : ${ymList}">
                        <label><input type="checkbox" name="ym" th:value="${y}" th:checked="${selectedYmList.contains(y)}" class="ym-cb"> <span th:text="${y}"></span></label>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="filter-group">
            <label>Î∂ÑÎ•ò</label>
            <select name="category">
                <option value="">Ï†ÑÏ≤¥</option>
                <option th:each="c : ${categoryList}" th:value="${c}" th:text="${c}" th:selected="${c == selectedCategory}"></option>
            </select>
        </div>
        <div class="filter-group">
            <label>Íµ¨Î∂Ñ</label>
            <div class="ym-dropdown" id="divDropdown">
                <button type="button" class="ym-dropdown-btn" id="divDropdownBtn">Ï†ÑÏ≤¥</button>
                <div class="ym-dropdown-list" id="divDropdownList">
                    <label class="all-label"><input type="checkbox" id="divAll" checked> Ï†ÑÏ≤¥</label>
                    <th:block th:each="d : ${divisionList}">
                        <label><input type="checkbox" name="division" th:value="${d}" th:checked="${selectedDivisionList.contains(d)}" class="div-cb"> <span th:text="${d}"></span></label>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="filter-group">
            <label>ÏÉÅÏÑ∏Ï°∞Í±¥</label>
            <div style="display:flex; gap:4px;">
                <select name="searchType" style="min-width:80px; height:34px; padding:7px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                    <option value="storeName" th:selected="${selectedSearchType == 'storeName'}">ÏÉÅÌò∏</option>
                    <option value="purpose" th:selected="${selectedSearchType == 'purpose'}">Ïö©ÎèÑ</option>
                </select>
                <input type="text" name="searchKeyword" th:value="${selectedSearchKeyword}" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•" style="width:150px; padding:7px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; height:34px;">
            </div>
        </div>
        <button type="submit" class="btn-filter">Ï°∞Ìöå</button>
        <a th:href="@{/expenses}" class="btn-reset">Ï¥àÍ∏∞Ìôî</a>
        <div class="btn-group-right">
            <a th:if="${isAdmin}" th:href="@{/expenses/new}" class="btn-add">+ Í≤ΩÎπÑ</a>
            <a th:href="@{/expenses/budget/new}" class="btn-add" style="background:#667eea;">+ ÏòàÏÇ∞</a>
            <a id="downloadBtn" href="#" class="btn-add" style="background:#ff9800;" onclick="doDownload(event)">Îã§Ïö¥Î°úÎìú</a>
            <a th:if="${isAdmin}" th:href="@{/expenses/upload}" class="btn-add" style="background:#2196F3;">ÏóÖÎ°úÎìú</a>
        </div>
    </form>

    <!-- ÏòàÏÇ∞ Ï¥àÍ≥º/Í≤ΩÍ≥† Î∞∞ÎÑà -->
    <div th:if="${usagePercent >= 100}" class="alert-banner danger">
        <span class="icon">&#9888;</span> ÏòàÏÇ∞ÏùÑ Ï¥àÍ≥ºÌñàÏäµÎãàÎã§! (ÏÇ¨Ïö©Î•† <span th:text="${usagePercent}"></span>%)
    </div>
    <div th:if="${usagePercent >= 80 and usagePercent < 100}" class="alert-banner">
        <span class="icon">&#9888;</span> ÏòàÏÇ∞ ÏÇ¨Ïö©Î•†Ïù¥ <span th:text="${usagePercent}"></span>%ÏûÖÎãàÎã§. Ï£ºÏùòÌï¥Ï£ºÏÑ∏Ïöî!
    </div>

    <!-- ÏòàÏÇ∞ ÏöîÏïΩ -->
    <div class="summary">
        <div class="summary-card budget-total">
            <div class="label">ÏòàÏÇ∞ Ìï©Í≥Ñ</div>
            <div class="value" th:text="${#numbers.formatDecimal(budgetTotal, 0, 'COMMA', 0, 'POINT')} + ' Ïõê'"></div>
        </div>
        <div class="summary-card monthly">
            <div class="label">Í∏àÏõî ÏòàÏÇ∞</div>
            <div class="value" th:text="${#numbers.formatDecimal(monthlyAmount, 0, 'COMMA', 0, 'POINT')} + ' Ïõê'"></div>
        </div>
        <div class="summary-card prev">
            <div class="label">Ï†ÑÏõî ÏûîÏó¨</div>
            <div class="value" th:text="${#numbers.formatDecimal(prevRemaining, 0, 'COMMA', 0, 'POINT')} + ' Ïõê'"></div>
        </div>
        <div class="summary-card used">
            <div class="label">ÏÇ¨Ïö© Í∏àÏï°</div>
            <div class="value" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' Ïõê'"></div>
        </div>
        <div class="summary-card remain">
            <div class="label">Í∏àÏõî ÏûîÏï°</div>
            <div class="value" th:classappend="${remaining.signum() < 0 ? 'negative' : ''}" th:text="${#numbers.formatDecimal(remaining, 0, 'COMMA', 0, 'POINT')} + ' Ïõê'"></div>
        </div>
        <div class="summary-card usage">
            <div class="label">ÏÇ¨Ïö©Î•†</div>
            <div class="value" th:classappend="${usagePercent >= 100 ? 'danger' : (usagePercent >= 80 ? 'warning' : '')}" th:text="${usagePercent} + '%'"></div>
            <div class="usage-bar">
                <div class="usage-bar-fill" th:style="'width:' + ${usagePercent > 100 ? 100 : usagePercent} + '%; background:' + ${usagePercent >= 100 ? '#ef5350' : (usagePercent >= 80 ? '#ff9800' : '#66bb6a')}"></div>
            </div>
        </div>
        <div class="summary-card count">
            <div class="label">Í±¥Ïàò</div>
            <div class="value" th:text="${totalCount} + ' Í±¥'"></div>
        </div>
    </div>

    <!-- Ï∞®Ìä∏ ÏòÅÏó≠ -->
    <div class="charts-row">
        <div class="chart-container bar-chart" th:if="${chartLabels.size() > 0}">
            <canvas id="monthlyChart" style="width:100%; height:100%;"></canvas>
        </div>
        <div class="chart-container pie-charts" th:if="${!expenses.isEmpty()}">
            <div class="pie-wrap">
                <canvas id="catPieChart"></canvas>
            </div>
            <div class="pie-wrap">
                <canvas id="divPieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î -->
    <div th:if="${!expenses.isEmpty()}" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <span style="font-size:13px; color:#666;">Ï°∞Ìöå Í≤∞Í≥º: <strong th:text="${totalCount}"></strong>Í±¥ | Ìï©Í≥Ñ: <strong th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')}"></strong>Ïõê</span>
    </div>
    <table th:if="${!expenses.isEmpty()}">
        <thead>
        <tr>
            <th class="sortable" data-col="0" data-type="text">ÎÇ†Ïßú</th>
            <th class="sortable" data-col="1" data-type="text">Î∂ÑÎ•ò</th>
            <th class="sortable" data-col="2" data-type="text">Íµ¨Î∂Ñ</th>
            <th>Ïö©ÎèÑ</th>
            <th class="sortable" data-col="4" data-type="text">ÏÉÅÌò∏</th>
            <th class="amount">Í∏àÏï°</th>
            <th>Í¥ÄÎ¶¨</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="exp : ${expenses}">
            <td th:text="${exp.expenseDate}"></td>
            <td>
                <span class="badge" th:classappend="${exp.category == 'LINK' ? 'badge-link' : 'badge-bugs'}" th:text="${exp.category}"></span>
            </td>
            <td th:text="${exp.division}"></td>
            <td th:text="${exp.purpose}"></td>
            <td th:text="${exp.storeName}"></td>
            <td class="amount" th:text="${#numbers.formatDecimal(exp.amount, 0, 'COMMA', 0, 'POINT')}"></td>
            <td>
                <div class="actions">
                    <a th:href="@{/expenses/{id}/edit(id=${exp.id})}" class="btn-sm btn-edit">ÏàòÏ†ï</a>
                    <a th:href="@{/expenses/{id}/delete(id=${exp.id}, ym=${selectedYm}, category=${selectedCategory}, division=${selectedDivision})}" class="btn-sm btn-delete"
                       onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</a>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <div th:if="${expenses.isEmpty()}" class="empty">
        <p>Ï°∞ÌöåÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
    </div>

    <!-- ÏòàÏÇ∞ Î™©Î°ù -->
    <div th:if="${!budgetList.isEmpty()}" style="margin-top: 24px;">
        <h3 style="color: #555; margin-bottom: 12px; font-size: 15px;">ÏòàÏÇ∞ ÌòÑÌô©</h3>
        <table>
            <thead>
            <tr>
                <th>ÎÖÑÏõî</th>
                <th>Î∂ÑÎ•ò</th>
                <th>Íµ¨Î∂Ñ</th>
                <th class="amount">Í∏àÏõî ÏòàÏÇ∞</th>
                <th class="amount">Ï†ÑÏõî ÏûîÏó¨</th>
                <th class="amount">ÏòàÏÇ∞ Ìï©Í≥Ñ</th>
                <th class="amount">ÏÇ¨Ïö©Í∏àÏï°</th>
                <th class="amount">Í∏àÏõî ÏûîÏï°</th>
                <th>ÏÇ¨Ïö©Î•†</th>
                <th>Í¥ÄÎ¶¨</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="b : ${budgetList}">
                <td th:text="${b.ym}"></td>
                <td>
                    <span class="badge" th:classappend="${b.category == 'LINK' ? 'badge-link' : 'badge-bugs'}" th:text="${b.category}"></span>
                </td>
                <td th:text="${b.division}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(b.monthlyAmount, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(b.prevRemaining, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:text="${#numbers.formatDecimal(b.totalBudget, 0, 'COMMA', 0, 'POINT')}"></td>
                <th:block th:with="budgetKey=${b.ym + '_' + b.category + '_' + b.division}, used=${usedAmountMap.containsKey(budgetKey) ? usedAmountMap.get(budgetKey) : T(java.math.BigDecimal).ZERO}, balance=${b.totalBudget.subtract(used)}, bUsage=${budgetUsageMap.containsKey(budgetKey) ? budgetUsageMap.get(budgetKey) : 0}">
                <td class="amount" th:text="${#numbers.formatDecimal(used, 0, 'COMMA', 0, 'POINT')}"></td>
                <td class="amount" th:classappend="${balance.signum() lt 0 ? ' negative' : ''}" th:text="${#numbers.formatDecimal(balance, 0, 'COMMA', 0, 'POINT')}"></td>
                <td>
                    <span th:classappend="${bUsage >= 100 ? 'danger' : (bUsage >= 80 ? 'warning' : '')}" th:text="${bUsage} + '%'" style="font-weight:600; font-size:13px;"></span>
                </td>
                </th:block>
                <td>
                    <div class="actions">
                        <a th:href="@{/expenses/budget/{id}/edit(id=${b.id})}" class="btn-sm btn-edit">ÏàòÏ†ï</a>
                        <a th:if="${isAdmin}" th:href="@{/expenses/budget/{id}/delete(id=${b.id}, ym=${b.ym}, category=${selectedCategory}, division=${selectedDivision})}" class="btn-sm btn-delete"
                           onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">ÏÇ≠Ï†ú</a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// Îã§ÌÅ¨ Î™®Îìú
function toggleDarkMode() {
    var isDark = document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}
(function() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
    }
})();

// Îã§Ïö¥Î°úÎìú: ÌòÑÏû¨ ÌèºÏùò ÌïÑÌÑ∞ Ï°∞Í±¥ÏúºÎ°ú Îã§Ïö¥Î°úÎìú
function doDownload(e) {
    e.preventDefault();
    var form = document.querySelector('.filter-bar');
    var params = new URLSearchParams(new FormData(form));
    window.location.href = '/expenses/download?' + params.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    // ======== Ïõî Ï≤¥ÌÅ¨Î∞ïÏä§ ÎìúÎ°≠Îã§Ïö¥ ========
    var btn = document.getElementById('ymDropdownBtn');
    var list = document.getElementById('ymDropdownList');
    var allCb = document.getElementById('ymAll');
    var ymCbs = document.querySelectorAll('.ym-cb');

    function updateBtnText() {
        var checked = Array.from(ymCbs).filter(function(c) { return c.checked; });
        if (checked.length === 0 || checked.length === ymCbs.length) {
            btn.textContent = 'Ï†ÑÏ≤¥';
            allCb.checked = true;
        } else if (checked.length === 1) {
            btn.textContent = checked[0].value;
            allCb.checked = false;
        } else {
            btn.textContent = checked[0].value + ' Ïô∏ ' + (checked.length - 1) + 'Í±¥';
            allCb.checked = false;
        }
    }

    // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
    var hasSelected = Array.from(ymCbs).some(function(c) { return c.checked; });
    if (!hasSelected) {
        allCb.checked = true;
    } else {
        allCb.checked = (Array.from(ymCbs).filter(function(c) { return c.checked; }).length === ymCbs.length);
    }
    updateBtnText();

    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        list.classList.toggle('open');
        divList.classList.remove('open');
    });

    document.addEventListener('click', function(e) {
        if (!document.getElementById('ymDropdown').contains(e.target)) {
            list.classList.remove('open');
        }
        if (!document.getElementById('divDropdown').contains(e.target)) {
            divList.classList.remove('open');
        }
    });

    allCb.addEventListener('change', function() {
        ymCbs.forEach(function(c) { c.checked = allCb.checked; });
        updateBtnText();
    });

    ymCbs.forEach(function(cb) {
        cb.addEventListener('change', function() {
            var allChecked = Array.from(ymCbs).every(function(c) { return c.checked; });
            var noneChecked = Array.from(ymCbs).every(function(c) { return !c.checked; });
            allCb.checked = allChecked || noneChecked;
            if (noneChecked) {
                ymCbs.forEach(function(c) { c.checked = false; });
            }
            updateBtnText();
        });
    });

    // ======== Íµ¨Î∂Ñ Ï≤¥ÌÅ¨Î∞ïÏä§ ÎìúÎ°≠Îã§Ïö¥ ========
    var divBtn = document.getElementById('divDropdownBtn');
    var divList = document.getElementById('divDropdownList');
    var divAll = document.getElementById('divAll');
    var divCbs = document.querySelectorAll('.div-cb');

    function updateDivBtnText() {
        var checked = Array.from(divCbs).filter(function(c) { return c.checked; });
        if (checked.length === 0 || checked.length === divCbs.length) {
            divBtn.textContent = 'Ï†ÑÏ≤¥';
            divAll.checked = true;
        } else if (checked.length === 1) {
            divBtn.textContent = checked[0].value;
            divAll.checked = false;
        } else {
            divBtn.textContent = checked[0].value + ' Ïô∏ ' + (checked.length - 1) + 'Í±¥';
            divAll.checked = false;
        }
    }

    var divHasSelected = Array.from(divCbs).some(function(c) { return c.checked; });
    if (!divHasSelected) {
        divAll.checked = true;
    } else {
        divAll.checked = (Array.from(divCbs).filter(function(c) { return c.checked; }).length === divCbs.length);
    }
    updateDivBtnText();

    divBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        divList.classList.toggle('open');
        list.classList.remove('open');
    });

    divAll.addEventListener('change', function() {
        divCbs.forEach(function(c) { c.checked = divAll.checked; });
        updateDivBtnText();
    });

    divCbs.forEach(function(cb) {
        cb.addEventListener('change', function() {
            var allChecked = Array.from(divCbs).every(function(c) { return c.checked; });
            var noneChecked = Array.from(divCbs).every(function(c) { return !c.checked; });
            divAll.checked = allChecked || noneChecked;
            if (noneChecked) {
                divCbs.forEach(function(c) { c.checked = false; });
            }
            updateDivBtnText();
        });
    });

    // ======== Ï†ïÎ†¨ ========
    function sortByCol(th, dir) {
        var table = th.closest('table');
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var col = parseInt(th.dataset.col);

        table.querySelectorAll('th.sortable').forEach(function(h) {
            h.classList.remove('asc', 'desc');
        });
        th.classList.add(dir);

        rows.sort(function(a, b) {
            var aText = a.cells[col].textContent.trim();
            var bText = b.cells[col].textContent.trim();
            var cmp = aText.localeCompare(bText, 'ko');
            return dir === 'asc' ? cmp : -cmp;
        });

        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    document.querySelectorAll('th.sortable').forEach(function(th) {
        th.addEventListener('click', function() {
            var isAsc = th.classList.contains('asc');
            sortByCol(th, isAsc ? 'desc' : 'asc');
        });
    });

    // ÎÇ†Ïßú Ïª¨Îüº Ï¥àÍ∏∞ Ï†ïÎ†¨: desc
    var dateTh = document.querySelector('th.sortable[data-col="0"]');
    if (dateTh) sortByCol(dateTh, 'desc');
});
</script>
<script th:inline="javascript">
// ======== ÏõîÎ≥Ñ ÏÇ¨Ïö©Í∏àÏï°/ÏûîÏó¨Í∏àÏï° Ï∞®Ìä∏ ========
(function() {
    var chartEl = document.getElementById('monthlyChart');
    if (!chartEl) return;
    var labels = /*[[${chartLabels}]]*/ [];
    var usedValues = /*[[${chartUsedValues}]]*/ [];
    var remainValues = /*[[${chartRemainValues}]]*/ [];
    var prevYearValues = /*[[${chartPrevYearValues}]]*/ [];
    var selectedYmList = /*[[${selectedYmList}]]*/ [];
    var hasSearchKeyword = /*[[${hasSearchKeyword}]]*/ false;
    var usedBg = labels.map(function(lbl) {
        return selectedYmList.indexOf(lbl) >= 0 ? '#ef5350' : '#f5b7b7';
    });
    var remainBg = labels.map(function(lbl) {
        return selectedYmList.indexOf(lbl) >= 0 ? '#66bb6a' : '#c0e6c2';
    });
    var datasets = [
        {
            label: 'ÏÇ¨Ïö©Í∏àÏï°',
            data: usedValues,
            backgroundColor: usedBg,
            borderRadius: 4,
            maxBarThickness: 40
        }
    ];
    // ÏÉÅÏÑ∏Ï°∞Í±¥(Í≤ÄÏÉâÏñ¥) ÏóÜÏùÑ ÎïåÎßå ÏûîÏó¨Í∏àÏï° ÌëúÏãú
    if (!hasSearchKeyword) {
        datasets.push({
            label: 'ÏûîÏó¨Í∏àÏï°',
            data: remainValues,
            backgroundColor: remainBg,
            borderRadius: 4,
            maxBarThickness: 40
        });
    }
    datasets.push({
        label: 'Ï†ÑÎÖÑ ÎèôÏõî',
        data: prevYearValues,
        type: 'line',
        borderColor: '#9e9e9e',
        borderDash: [5, 5],
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: '#9e9e9e',
        fill: false,
        tension: 0.3
    });
    new Chart(chartEl, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { font: { family: 'Pretendard', size: 12 }, usePointStyle: true, pointStyle: 'rectRounded', padding: 16 }
                },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            return ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString('ko-KR') + ' Ïõê';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(v) { return v.toLocaleString('ko-KR'); },
                        font: { family: 'Pretendard', size: 11 }
                    },
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    ticks: {
                        font: function(ctx) {
                            var lbl = labels[ctx.index];
                            var isSel = selectedYmList.indexOf(lbl) >= 0;
                            return { family: 'Pretendard', size: isSel ? 13 : 11, weight: isSel ? 'bold' : 'normal' };
                        },
                        color: function(ctx) {
                            var lbl = labels[ctx.index];
                            return selectedYmList.indexOf(lbl) >= 0 ? '#333' : '#999';
                        }
                    },
                    grid: { display: false }
                }
            }
        }
    });
})();

// ======== Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌååÏù¥ Ï∞®Ìä∏ ========
(function() {
    var catEl = document.getElementById('catPieChart');
    if (!catEl) return;
    var pieLabels = /*[[${pieLabels}]]*/ [];
    var pieValues = /*[[${pieValues}]]*/ [];
    var catColors = { 'LINK': '#42a5f5', 'BUGS': '#ef5350' };
    var bgColors = pieLabels.map(function(l) { return catColors[l] || '#bdbdbd'; });
    new Chart(catEl, {
        type: 'doughnut',
        data: { labels: pieLabels, datasets: [{ data: pieValues, backgroundColor: bgColors, borderWidth: 2, borderColor: '#fff' }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Î∂ÑÎ•òÎ≥Ñ', font: { family: 'Pretendard', size: 13, weight: 'bold' } },
                legend: { position: 'bottom', labels: { font: { family: 'Pretendard', size: 11 }, padding: 8, usePointStyle: true } },
                tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + ctx.parsed.toLocaleString('ko-KR') + ' Ïõê'; } } }
            }
        }
    });
})();

// ======== Íµ¨Î∂ÑÎ≥Ñ ÌååÏù¥ Ï∞®Ìä∏ ========
(function() {
    var divEl = document.getElementById('divPieChart');
    if (!divEl) return;
    var pieDivLabels = /*[[${pieDivLabels}]]*/ [];
    var pieDivValues = /*[[${pieDivValues}]]*/ [];
    var divColors = ['#667eea','#66bb6a','#ffa726','#ab47bc','#26c6da','#ef5350','#8d6e63'];
    new Chart(divEl, {
        type: 'doughnut',
        data: { labels: pieDivLabels, datasets: [{ data: pieDivValues, backgroundColor: divColors.slice(0, pieDivLabels.length), borderWidth: 2, borderColor: '#fff' }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: 'Íµ¨Î∂ÑÎ≥Ñ', font: { family: 'Pretendard', size: 13, weight: 'bold' } },
                legend: { position: 'bottom', labels: { font: { family: 'Pretendard', size: 11 }, padding: 8, usePointStyle: true } },
                tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + ctx.parsed.toLocaleString('ko-KR') + ' Ïõê'; } } }
            }
        }
    });
})();
</script>
</body>
</html>
